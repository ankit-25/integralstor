{% extends 'storage_base.html' %}

{%block tab_header %}
  ZFS pool details
{%endblock%}

{%block inside_content %}

  {% if not pool %}
    No information for the specified pool. Click <a href="/view_zfs_pools/"> here</a> to view all ZFS storage pools.
  {%else %}

    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              Pool information <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
          <div class="panel-body">
              <table class="table table-bordered table-hover table-responsive" style="width:800px">
                <tr><th> Pool name </th> <td><b>{{pool.pool_name}}</b></td></tr>
                <tr><th> Pool type </th> <td>{{pool.config.pool.type.upper}}</td></tr>
                <tr><th> Pool state </th> <td>{{pool.state}}</td></tr>
                <tr><th> Pool errors </th> <td>{{pool.errors}}</td></tr>
                <tr> <th> Pool scan </th> <td>{{pool.scan}}</td></tr>
              </table>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading2">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse2" aria-expanded="true" aria-controls="collapse2">
              Pool Usage <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse2" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading2">
          <div class="panel-body">
              <div class="progress" style="background: rgba(204, 188, 188, 1); border: 1px solid rgba(245, 245, 245, 1); ">
                <div class="progress-bar {%if pool.usage.used_percent.value > 50 and pool.usage.used_percent.value < 70 %}  progress-bar-warning {%elif pool.usage.used_percent.value >= 70 %}  progress-bar-danger{%else%} progress-bar-info {%endif%}" role="progressbar" aria-valuenow="{{pool.usage.used_percent.value}}" aria-valuemin="0" aria-valuemax="100" style="{%if pool.usage.used_percent.value %} width: {{pool.usage.used_percent.value}}%;{%endif%}min-width: 3em;">
                  {{pool.usage.used_percent.value|floatformat}}%
                </div>
              </div>
              <table class="table table-bordered table-hover table-responsive" style="width:800px">
                <tr><th> Pool size </th> <td>{{pool.usage.size.value}}{{pool.usage.size.unit}}<td></tr>
                <tr><th> Pool usage </th> <td>{{pool.usage.used.value}}{{pool.usage.used.unit}}<td></tr>
                <tr><th> Pool free space </th> <td>{{pool.usage.free.value}}{{pool.usage.free.unit}}<td></tr>
              </table>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading3">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse3" aria-expanded="true" aria-controls="collapse3">
              Pool components <span class="caret"></span>
             </a>
          </h5>
        </div>
        <div id="collapse3" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading3">
          <div class="panel-body">
            <ul>
              {%for child in pool.config.pool.root.children %}
                <li> 
                  {{child.name}} ({{child.type}}), State ({{child.status.state}}), Read ({{child.status.read}}), Write ({{child.status.write}}), Chksum ({{child.status.chksum}})
                  {%if child.children %}
                    <ul>
                      {%for gr_child in child.children %}
                        <li> {{gr_child.name}} ({{gr_child.type}}), State ({{gr_child.status.state}}), Read ({{gr_child.status.read}}), Write ({{gr_child.status.write}}), Chksum ({{gr_child.status.chksum}})
                        {%if gr_child.children %}
                          <ul>
                            {%for gr_gr_child in gr_child.children %}
                              <li> {{gr_gr_child.name}} ({{gr_gr_child.type}}), State ({{gr_gr_child.status.state}}), Read ({{gr_gr_child.status.read}}), Write ({{gr_gr_child.status.write}}), Chksum ({{gr_gr_child.status.chksum}})
                            {%endfor%}
                          </ul>
                        {%endif%}
                      {%endfor%}
                    </ul>
                  {%endif%}
              {%endfor%}
            </ul>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading4">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse4" aria-expanded="true" aria-controls="collapse4">
              Spare disks <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse4" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading4">
          <div class="panel-body">
            {% if pool.config.spares %}
              <table class="table table-bordered table-hover table-responsive" >
                <th> Disk ID </th>
                <th> Status </th>
                {%for id, status in pool.config.spares.items%}
                  <tr>
                    <td> {{id}} </td>
                    <td> {{status}} </td>
                  </tr>
                {%endfor%}
              </table>
            {%else%}
              No spare disks assigned. <br><br>
            {%endif%}
            {% if not num_free_disks_for_spares  %}
              There are currently no free disks to be added as spares.<br>
            {%endif%}
            <div class="btn-group btn-group-sm" role="group" aria-label="...">
              {% if num_free_disks_for_spares  %}
                <a href="/add_zfs_spares?pool_name={{pool.pool_name}}" role="button" class="btn btn-primary " {% if not num_free_disks_for_spares  %} disabled {%endif%}>Add spare drive(s)</a>
              {%else%}
                &nbsp;
              {%endif%}
              {% if pool.config.spares %}
                <a href="/remove_zfs_spare?pool_name={{pool.pool_name}}" role="button" class="btn btn-danger">Remove a spare disk</a>
              {%endif%}
            </div>
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading5">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse5" aria-expanded="true" aria-controls="collapse5">
              Write cache <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse5" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading5">
          <div class="panel-body">
            {% if pool.config.logs %}
              <b> Write cache components</b>
              <ul>
                {%for child in pool.config.logs.root.children %}
                  <li> Name - {{child.name}}, Type - {{child.type}}
                  {%if child.type == 'RAMDisk' and child.ramdisk_size %}, RAM Disk size - {{child.ramdisk_size}}MB {%endif%}
                    , Status - State ({{child.status.state}}), Read ({{child.status.read}}), Write ({{child.status.write}}), Chksum ({{child.status.chksum}})
i                   {%if child.children %}
                      <ul>
                        {%for gr_child in child.children %}
                          <li> Name - {{gr_child.name}}, Type - {{gr_child.type}}, Status - State ({{gr_child.status.state}}), Read ({{gr_child.status.read}}), Write ({{gr_child.status.write}}), Chksum ({{gr_child.status.chksum}})
                            {%if gr_child.children %}
                              <ul>
                                {%for gr_gr_child in gr_child.children %}
                                  <li> Name - {{gr_gr_child.name}}, Type - {{gr_gr_child.type}}, Status - State ({{gr_gr_child.status.state}}), Read ({{gr_gr_child.status.read}}), Write ({{gr_gr_child.status.write}}), Chksum ({{gr_gr_child.status.chksum}})
                                {%endfor%}
                              </ul>
                            {%endif%}
                        {%endfor%}
                      </ul>
                    {%endif%}
                {%endfor%}
              </ul>
              {% if pool.config.logs.root.children.0.type == 'RAMDisk' %}
                <a href="/remove_zfs_slog?pool={{pool.pool_name}}&device={{pool.config.logs.root.children.0.name}}&type=ramdisk" role="button" class="btn btn-danger btn-sm"> Remove the write cache RAMDisk device</a>
              {%else%}
                <a href="/remove_zfs_slog?pool={{pool.pool_name}}&device={{pool.config.logs.root.children.0.name}}&type=flash" role="button" class="btn btn-danger btn-sm"> Remove the write cache flash device</a>
              {%endif%}
            {%else%}
              <b>Write cache in use : </b> Disk<br><br>
              <a href="/set_zfs_slog?pool={{pool.pool_name}}" role="button" class="btn btn-primary btn-sm"> Change the write cache device</a>
            {%endif%}
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading6">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse6" aria-expanded="true" aria-controls="collapse6">
              Read cache <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse6" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading6">
          <div class="panel-body">
            {% if pool.config.cache %}
              <b> Read cache components</b>
              <ul>
                {%for child in pool.config.cache.root.children %}
                  <li> Name - {{child.name}}, Type - {{child.type}}, Status - State ({{child.status.state}}), Read ({{child.status.read}}), Write ({{child.status.write}}), Chksum ({{child.status.chksum}})
                  {%if child.children %}
                    <ul>
                      {%for gr_child in child.children %}
                        <li> Name - {{gr_child.name}}, Type - {{gr_child.type}}, Status - State ({{gr_child.status.state}}), Read ({{gr_child.status.read}}), Write ({{gr_child.status.write}}), Chksum ({{gr_child.status.chksum}})
                        {%if gr_child.children %}
                          <ul>
                            {%for gr_gr_child in gr_child.children %}
                              <li> Name - {{gr_gr_child.name}}, Type - {{gr_gr_child.type}}, Status - State ({{gr_gr_child.status.state}}), Read ({{gr_gr_child.status.read}}), Write ({{gr_gr_child.status.write}}), Chksum ({{gr_gr_child.status.chksum}})
                            {%endfor%}
                          </ul>
                        {%endif%}
                      {%endfor%}
                    </ul>
                  {%endif%}
                {%endfor%}
              </ul>
              <a href="/remove_zfs_l2arc?pool={{pool.pool_name}}&device={{pool.config.cache.root.children.0.name}}" role="button" class="btn btn-danger btn-sm"> Remove the read cache device</a>
            {%else%}
              <b>Read cache in use : </b> RAM<br><br>
              {%if num_free_disks_for_cache %}
                <a href="/set_zfs_l2arc?pool={{pool.pool_name}}" role="button" class="btn btn-primary btn-sm"> Change the read cache device</a>
              {%else%}
                There are no unused flash drives to use as a read cache.
              {%endif%}
            {%endif%}
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading8">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse8" aria-expanded="true" aria-controls="collapse8">
              Filesystem datasets <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse8" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading8">
          <div class="panel-body">
            {% if pool.datasets %}
              <table  class="table table-bordered">
                <tr>
                  <th colspan=3> Filesystem datasets in this pool</th>
                </tr>
                <tr>
                  <th> Name</th>
                  <th> Space used</th>
                  <!--<th> Snapshots</th>-->
                  <th> &nbsp;</th>
                  <th> &nbsp;</th>
                </tr>
                {%for ds in pool.datasets%}
                  {% if ds.properties.type.value == 'filesystem'%}
                    <tr>
                      <td>{{ds.name}}</td>
                      <td>{{ds.used}}</td> 
                      <!--<td>{%if 'snapshots' in ds%} <ul> {%for sn in ds.snapshots%}<li>{{sn.snapshot_name}},{%endfor%}</ul>{%else%} &nbsp;{%endif%}</td>-->
                      <td><a href="/view_zfs_dataset?name={{ds.name}}" role="button" class="btn btn-info btn-xs"> Details</a></td> 
                      <td><a href="/replicate_zfs_pool?pool_name={{ds.name}}" role="button" class="btn btn-info btn-xs">Replicate this dataset</a></td>
                    </tr>
                  {%endif%}
                {%endfor%}
              </table>
              <a href="/create_zfs_dataset?pool={{pool.pool_name}}&parent={{pool.pool_name}}" role="button" class="btn btn-primary btn-sm"> Create a new filesystem dataset</a>
            {%else%}
              <p> No filesystem datasets created </p>
              <a href="/create_zfs_dataset?pool={{pool.pool_name}}&parent={{pool.pool_name}}" role="button" class="btn btn-primary btn-sm"> Create a filesystem dataset</a>
            {%endif%}
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading9">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse9" aria-expanded="true" aria-controls="collapse9">
              Block device volumes <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse9" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading9">
          <div class="panel-body">
            {% if pool.datasets %}
              <table  class="table table-bordered">
                <tr>
                  <th colspan=3> Block device volumes in this pool</th>
                </tr>
                <tr>
                  <th> Name</th>
                  <th> Space used</th>
                  <!--<th> Snapshots</th>-->
                  <th> &nbsp;</th>
                </tr>
                {%for ds in pool.datasets%}
                  {% if ds.properties.type.value == 'volume'%}
                    <tr>
                      <td>{{ds.name}}</td>
                      <td>{{ds.used}}</td> 
                      <!--<td>{%if 'snapshots' in ds%} <ul> {%for sn in ds.snapshots%}<li>{{sn.snapshot_name}},{%endfor%}</ul>{%else%} &nbsp;{%endif%}</td>-->
                      <td><a href="/view_zfs_zvol?name={{ds.name}}&pool_name={{pool.pool_name}}" role="button" class="btn btn-info btn-xs"> Details</a></td> 
                    </tr>
                  {%endif%}
                {%endfor%}
              </table>
              <a href="/create_zfs_zvol?pool={{pool.pool_name}}" role="button" class="btn btn-primary btn-sm"> Create a new block device volume</a>
            {%else%}
              <p> No block device volumes created </p>
              <a href="/create_zfs_zvol?pool={{pool.pool_name}}" role="button" class="btn btn-primary btn-sm"> Create a new block device volume</a>
            {%endif%}
          </div>
        </div>
      </div>

      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="heading7">
          <h5 class="panel-title">
            <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse7" aria-expanded="true" aria-controls="collapse7">
              Pool quotas <span class="caret"></span>
            </a>
          </h5>
        </div>
        <div id="collapse7" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading7">
          <div class="panel-body">
            {% if not quotas.users and not quotas.groups%}
              <p>No quotas appear to have been set for this pool. </p>
            {%else %}
              <div style="width:95%;position: relative; margin: 5px 0px; padding: 9px 9px 4px; background-color: rgb(255, 255, 255); border: 1px solid rgb(221, 221, 221); border-radius: 4px 4px 4px 4px;">
                <table  class="table table-bordered">
                  <tr>
                    <th > Name </th>
                    <th > Type </th>
                    <th > Quota </th>
                    <th> Remove quota </th>
                  </tr>
                  {%for un, q in quotas.users.items %}
                    <tr>
                      <td> {{un}} </td>
                      <td> User </td>
                      <td> {{q}} </td>
                      <td>
                        <a href="/remove_zfs_quota?path={{pool.pool_name}}&path_type=pool&ug_name={{un}}&ug_type=user&pool_name={{pool.pool_name}}" role="button" class="btn btn-danger btn-xs"> Remove this quota</a>
                      </td>
                    </tr>
                  {%endfor%}
                  {%for gn, q in quotas.groups.items %}
                    <tr>
                      <td> {{gn}} </td>
                      <td> Group </td>
                      <td> {{q}} </td>
                      <td>
                        <a href="/remove_zfs_quota?path={{pool.pool_name}}&path_type=pool&ug_name={{gn}}&ug_type=group&pool_name={{pool.pool_name}}" role="button" class="btn btn-danger btn-xs"> Remove this quota</a>
                      </td>
                    </tr>
                  {%endfor%}
                </table>
              </div>
            {%endif%}
            <div class="btn-group btn-group-sm" role="group" aria-label="...">
              <a href="/set_zfs_quota?path={{pool.pool_name}}&path_type=pool&ug_type=user&pool_name={{pool.pool_name}}" role="button" class="btn btn-primary">Add user quota</a>
              <a href="/set_zfs_quota?path={{pool.pool_name}}&path_type=pool&ug_type=group&pool_name={{pool.pool_name}}" role="button" class="btn btn-primary">Add group quota</a>
            </div>
          </div>
        </div>
      </div>

    </div>

  {%endif%}
  <br>
  <div class="btn-toolbar" role="toolbar" aria-label="...">
    <div class="btn-group btn-group-sm" role="group" aria-label="...">
      <a href="/view_zfs_pools" role="button" class="btn btn-default">Back to pool list</a>
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="...">
      <a href="/set_file_owner_and_permissions?path={{pool.properties.mountpoint.value}}&pool_name={{pool.pool_name}}&from=pool" role="button" class="btn btn-info"> Change ownership and permissions</a>
      <a href="/scrub_zfs_pool?name={{pool.pool_name}}" role="button" class="btn btn-info">Initiate a scrub</a>
      {%if can_expand_pool %}
        <a href="/expand_zfs_pool?pool_name={{pool.pool_name}}" role="button" class="btn btn-info">Expand this pool</a>
      {%endif%}
    </div>
    <div class="btn-group btn-group-sm" role="group" aria-label="...">
      <a href="/export_zfs_pool?pool_name={{pool.pool_name}}" role="button" class="btn btn-danger"> Export this pool</a>
      <a href="/delete_zfs_pool?name={{pool.pool_name}}" role="button" class="btn btn-danger"> Delete this pool</a>
    </div>
  </div>

{%endblock%}

{%block help_header%}
  View all ZFS pools
{%endblock%}

{%block help_body%}
  <p> This screen provides the list of all the ZFS pools that have been created on this IntegralStor system. To view details about a particular ZFS pool, please select the the desired pool from the list.</p>
{%endblock%}

{% block tab_active %}
  <script>
    make_tab_active("view_zfs_pools_tab")
  </script>
{% endblock %}


